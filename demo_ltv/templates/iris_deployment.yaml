apiVersion: intersystems.com/v1alpha1
kind: IrisCluster
metadata:
  name: {{.Release.Name}}
  namespace: {{.Release.Namespace}}
spec:
  licenseKeySecret:
    name: iris-key-secret
  configSource:
    name: iris-cpf-config-map
  topology:
    data:
      podTemplate:
        spec:
          {{- if eq .Values.cloudProvider "AWS" }}
          {{- if .Values.compute.database.nodeTypeSelector }}
          nodeSelector:
            sds/node-type: {{ .Values.compute.database.nodeTypeSelector }}
          {{- end }}
          {{- if or .Values.compute.database.cpu .Values.compute.database.memory }}
          resources:
            requests:
              {{- if .Values.compute.database.cpu }}
              cpu: {{ .Values.compute.database.cpu }}
              {{- end }}
              {{- if .Values.compute.database.memory }}
              memory: {{ .Values.compute.database.memory }}
              {{- end }}
          {{- end }}
          {{- end }}
          
        {{- if .Values.imagePullSecrets }}
          imagePullSecrets:      
{{ toYaml .Values.imagePullSecrets | indent 10 }}
        {{- end }}
          env:
          - name: CLOUD_PROVIDER
            value: {{ .Values.cloudProvider }}
          - name: CLOUD_PROVIDER_REGION
            value: {{ .Values.cloudProviderRegion }}
          - name: SERVICE_INTERNAL_NAME
            value: {{ .Values.serviceInternalName }}
          - name: KAFKA_BROKER
            value: {{ .Values.kafkaBroker }}

      mirrored: {{.Values.mirrored}}
      {{- if eq .Values.skaffold true }}
      image: {{ .Values.skaffoldImage }}
      {{- else }}
      image: {{ .Values.image.registry }}/{{ .Values.image.backend.repository }}:{{ .Values.image.tag }}
      {{- end }}

      updateStrategy:
        type: RollingUpdate
      storageDB:
        resources:
          requests:
            storage: {{.Values.storageDB.size}}
        storageClassName: {{.Values.storageDB.storageClass}}
      storageWIJ:
        resources:
          requests:
            storage: {{.Values.storageWIJ.size}}
        storageClassName: {{.Values.storageWIJ.storageClass}}
      storageJournal1:
        resources:
          requests:
            storage: {{.Values.storageJournal1.size}}
        storageClassName: {{.Values.storageJournal1.storageClass}}
      storageJournal2:
        resources:
          requests:
            storage: {{.Values.storageJournal2.size}}
        storageClassName: {{.Values.storageJournal2.storageClass}}
  serviceTemplate:
      spec:
        type: ClusterIP